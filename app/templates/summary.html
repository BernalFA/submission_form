{% extends 'base.html' %}

{% block title %}
<title>COMAS submission summary</title>
{% endblock %}


{% block main %}

<style>
.table thead th {
    position: sticky; /* keep header when scrolling */
    top: 0;
    background: #fff;
    z-index: 2; /* ensures stacking above other elements */
    box-shadow: 0 3px 0 0 #000; /* Adds a shadow line for extra visibility */
}
</style>

<div class="d-flex justify-content-between">
  <p class="lead">
    Following you have the summary of the information provided. 
    To agree with it and finalize this session, please press <strong>Finish</strong>.
  </p>
</div>

<div class="container">
  <div class="card p-2 p-md-5 border rounded-3">
    <div class="row g3">
      <div class="col-md-2">
        <h3>Summary</h3>
        <hr>
      </div>
      <div class="col-md-10"></div>
      <div class="col-md-4">
        <strong>User:</strong> {{ user.username }}
      </div>
      <div class="col-md-4">
        {% if "vials" in delivery %}
          <strong>Delivery:</strong> vials
        {% else %}
          <strong>Delivery:</strong> plate
        {% endif %}
      </div>
      <div class="col-md-4">
        <strong>Sample type:</strong> {{ sample_type }}
      </div>
      <div class="col-md-4">
        {% if include_structures %}
          <strong>Provide structures:</strong> yes
        {% else %}
          <strong>Provide structures:</strong> no
        {% endif %}
      </div>
      <div class="col-md-4">
        <strong>Compounds registered:</strong> {{ compounds | length }}
      </div>
    </div>
    <div class="row mb-4"></div>
    <hr>
    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
      <table class="table table-striped">
        <thead>
          {% block thead %}{% endblock %}
        </thead>
        <tbody>
          {% block tbody %}{% endblock %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<hr>

<div class="container">
  <div class="row g-3">
    <div class="col-md-3"></div>
    <div class="col-md-6 text-end">
      <a href="{{ url_for('main.reset_session') }}" class="w-100 btn btn-primary">Finish</a>
    </div>
  </div>
</div>

<!-- This js section activates hover -->
<!-- obtained with help of ChatGPT -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const cells = document.querySelectorAll('.smiles-popover');

    cells.forEach(cell => {
      const popover = new bootstrap.Popover(cell, {
        html: true,
        trigger: 'hover',
        content: 'Loading...',
        placement: 'right',
        title: ''
      });

      cell.addEventListener('mouseenter', async () => {
        const smiles = encodeURIComponent(cell.dataset.smiles);
        try {
          const res = await fetch(`/mol_png/${smiles}`);
          const html = await res.text();
          popover.setContent({ '.popover-body': html });
        } catch (err) {
          popover.setContent({ '.popover-body': 'Error loading image.' });
        }
      });
    });
  });
</script>

{% endblock %}
